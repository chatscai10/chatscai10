# 獎金任務系統優化設計文檔

## 1. 系統概述

本文檔描述「吃雞排找不早」系統獎金任務模塊的擴展和優化設計。主要目的是創建更加完善的團隊合作獎懲制度，激勵員工團隊協作能力，同時提供更靈活的獎金設定方式。

## 2. 資料庫結構更新

### 2.1 擴展 `bonus_tasks` 集合

現有欄位：
- `name`: 任務名稱
- `description`: 任務描述
- `rewardValue`: 獎勵值
- `isActive`: 是否啟用
- `isSelectable`: 是否可選
- `conditionsLogic`: 條件邏輯（AND/OR）
- `conditions`: 條件陣列
- `evaluationConfig`: 評估設定
- `unlockConditions`: 解鎖條件

新增欄位：
- `plainExplanation`: 白話文解釋（String）
- `positionRestrictions`: 職位限制陣列（Array）
- `category`: 類別（String: "個人", "團體", "混合"）
- `isGroupTask`: 是否為團體任務（Boolean）
- `groupMinParticipants`: 最小參與人數（Number）
- `requiredVotes`: 啟用所需投票數量（Number）
- `voteThreshold`: 投票通過門檻（Number, 0-1表示百分比）
- `penaltyOnFailure`: 失敗懲罰（Object）
- `bonusFormula`: 獎金計算公式（String）
- `taskTags`: 任務標籤陣列（Array）

### 2.2 新增 `bonus_templates` 集合

欄位：
- `id`: 模板ID
- `name`: 模板名稱
- `description`: 模板描述
- `category`: 類別
- `tasks`: 任務設定陣列
- `isSystem`: 是否為系統預設（Boolean）
- `createdBy`: 創建者
- `createdAt`: 創建時間

### 2.3 新增 `performance_scoring` 集合

欄位：
- `id`: 設定ID
- `name`: 設定名稱
- `description`: 描述
- `components`: 評分組成部分（Array of Objects）
  - `type`: 類型（"客戶評價", "同事評價", "出勤", "銷售", "管理者評價"）
  - `weight`: 權重（0-1）
  - `isActive`: 是否啟用
  - `metrics`: 指標（Array of Objects）
- `positionBaselines`: 各職位基礎分數（Object）
- `evaluationPeriod`: 評估週期（"monthly", "quarterly", "annually"）

### 2.4 新增 `year_end_bonus_pool` 集合

欄位：
- `year`: 年份
- `totalAmount`: 總額
- `percentOfRevenue`: 營收百分比
- `distributionRules`: 分配規則
- `status`: 狀態（"accumulating", "finalized", "distributed"）
- `createdAt`: 創建時間
- `updatedAt`: 更新時間
- `allocations`: 分配記錄（分配後填入）

### 2.5 新增 `employee_evaluations` 集合

欄位：
- `employeeId`: 員工ID
- `year`: 年份
- `month`: 月份
- `overallScore`: 總分
- `componentScores`: 各組成部分分數
- `notes`: 備註
- `evaluatedBy`: 評估者
- `evaluatedAt`: 評估時間
- `status`: 狀態

### 2.6 新增 `bonus_wheel` 集合

欄位：
- `id`: 輪盤ID
- `name`: 名稱
- `segments`: 獎項段落陣列
  - `label`: 標籤
  - `value`: 值
  - `probability`: 機率
  - `color`: 顏色
- `availabilityRules`: 可用性規則
- `storeRestrictions`: 店鋪限制
- `positionRestrictions`: 職位限制
- `isActive`: 是否啟用

### 2.7 新增 `bonus_votes` 集合

欄位：
- `taskId`: 獎金任務ID
- `employeeId`: 員工ID
- `vote`: 投票（"approve", "reject"）
- `reason`: 原因
- `votedAt`: 投票時間

## 3. UI/UX 設計

### 3.1 管理員界面優化

#### 3.1.1 獎金任務設定頁面

1. 任務編輯模態框新增欄位：
   - 白話文解釋區域
   - 職位限制多選框
   - 團體任務設定區塊
   - 獎金公式編輯區

2. 任務列表顯示優化：
   - 類別標籤（個人/團體）
   - 狀態指示器（有條件顯示）
   - 預覽按鈕（顯示白話文解釋）

3. 任務模板庫：
   - 系統預設模板列表
   - 自定義模板創建/編輯
   - 一鍵應用模板按鈕

4. 年終獎金池設定：
   - 營收百分比設定
   - 分配規則配置
   - 模擬分配結果顯示

#### 3.1.2 績效評分設定頁面

1. 評分組成設定：
   - 各評分方面權重設定
   - 可啟用/停用各評分方面
   - 指標定義界面

2. 職位基準分設定：
   - 各職位月度基準分設定
   - 職位等級晉升條件設定

3. 評分期間設定：
   - 評分週期選擇
   - 自動計算設定

#### 3.1.3 獎金機率輪盤設定：

1. 輪盤獎項設定：
   - 獎項內容和機率設定
   - 顏色和顯示設定

2. 輪盤使用規則：
   - 使用條件設定
   - 使用頻率限制
   - 職位限制設定

### 3.2 員工界面優化

#### 3.2.1 獎金任務顯示優化

1. 可參與任務列表：
   - 已解鎖任務突出顯示
   - 未解鎖任務顯示解鎖條件進度
   - 白話文解釋顯示

2. 團體任務區域：
   - 團隊進度指示器
   - 團隊成員貢獻度顯示
   - 投票發起按鈕

3. 個人績效儀表板：
   - 各方面得分顯示
   - 歷史績效趨勢圖
   - 與團隊平均的比較

#### 3.2.2 獎金池顯示

1. 年終獎金池視覺效果：
   - 金色閃耀動畫效果
   - 累積金額實時顯示
   - 個人預估分配額顯示

2. 獎金機率輪盤：
   - 3D旋轉動畫效果
   - 獲獎歷史記錄
   - 使用次數顯示

## 4. 功能模塊設計

### 4.1 白話文解釋生成器

設計公式和條件的自動解釋邏輯，將複雜條件自動轉換為易懂的中文描述。

示例：
- 條件：`days_employed >= 100 AND on_time_rate >= 0.9`
- 生成解釋：「需要在職滿100天，且準時率達到90%或以上才能獲得此獎金」

### 4.2 任務解鎖進度計算器

為每個任務計算當前員工的解鎖進度，並顯示還需達成的條件。

示例：
- 未達成條件：`days_employed >= 100` (當前值：70)
- 顯示：「距離開啟此任務還差30天」

### 4.3 團體投票機制

1. 投票發起流程：
   - 條件檢查（是否符合發起條件）
   - 設定投票期限
   - 通知相關成員

2. 投票處理流程：
   - 投票結果統計
   - 自動執行結果（通過/拒絕）
   - 結果通知

3. 申訴機制：
   - 申訴條件設定
   - 申訴處理流程
   - 管理員審核界面

### 4.4 綜合分數計算引擎

1. 數據收集：
   - 客戶評價收集接口
   - 同事互評機制
   - 出勤數據整合
   - 銷售績效整合
   - 管理者評價收集

2. 分數計算：
   - 權重應用算法
   - 標準化處理
   - 異常值處理
   - 最終得分合成

3. 結果應用：
   - 績效報告生成
   - 獎金分配應用
   - 晉升建議生成

### 4.5 獎金輪盤系統

1. 獎項管理：
   - 獎項定義界面
   - 機率設定工具
   - 機率驗證機制

2. 使用權限：
   - 使用條件檢查
   - 使用次數管理
   - 使用結果記錄

3. 輪盤UI：
   - 3D旋轉動畫
   - 獲獎閃爍效果
   - 結果展示界面

### 4.6 年終獎金池

1. 獎金池計算：
   - 營收數據整合
   - 百分比應用
   - 累積金額計算

2. 分配機制：
   - 基於績效的分配算法
   - 職位加權調整
   - 特殊貢獻獎勵

3. 視覺效果：
   - 閃爍金幣動畫
   - 水波紋積累效果
   - 即時更新顯示

## 5. 預設任務組合庫設計

### 5.1 基礎職位相關組合

1. 店長專屬任務組合：
   - 店鋪營收目標達成
   - 團隊管理效能
   - 庫存優化獎勵

2. 資深員工任務組合：
   - 培訓新人任務
   - 客戶滿意度維護
   - 工作流程優化

3. 新進員工任務組合：
   - 技能掌握獎勵
   - 出勤優良獎勵
   - 初期適應獎勵

### 5.2 團隊合作組合

1. 整店協作套件：
   - 全員準時獎勵
   - 團隊銷售目標
   - 零客訴挑戰

2. 小組競賽套件：
   - 小組銷售競賽
   - 創新提案競賽
   - 客戶服務競賽

3. 互助成長套件：
   - 同儕教學獎勵
   - 全員技能提升
   - 互評優良激勵

### 5.3 節日與特殊活動組合

1. 年節活動套件：
   - 春節銷售衝刺
   - 年終大掃除
   - 節日氣氛營造

2. 店慶活動套件：
   - 店慶銷售目標
   - 顧客回饋收集
   - 特別活動協作

3. 季節性商品套件：
   - 季節限定商品銷售
   - 新品推廣任務
   - 顧客評價收集

## 6. 技術實現方案

### 6.1 前端架構

1. 組件設計：
   - BonusTaskCard 組件 - 顯示任務卡片與解鎖進度
   - GroupTaskProgress 組件 - 顯示團體任務進度
   - PerformanceChart 組件 - 顯示績效評分圖表
   - BonusWheel 組件 - 實現旋轉輪盤效果
   - BonusPool 組件 - 實現獎金池動畫效果

2. 數據流設計：
   - Firestore 實時監聽任務與進度
   - 用戶操作觸發本地狀態更新
   - 定期同步更新績效數據

### 6.2 後端架構

1. Firestore 查詢優化：
   - 高效篩選可用任務
   - 批量更新進度數據
   - 適當使用複合索引

2. 雲函數設計：
   - 定期績效計算函數
   - 獎金池更新函數
   - 投票處理函數
   - 條件檢查與獎勵發放函數

3. 權限設計：
   - 細粒度訪問控制
   - 用戶權限檢查
   - 管理員操作審計

### 6.3 性能與擴展性考慮

1. 數據批量處理：
   - 分批計算績效分數
   - 避免大批量文檔更新
   - 使用聚合查詢減少流量

2. 前端性能優化：
   - 懶加載任務數據
   - 本地緩存常用設定
   - 優化動畫渲染效能

3. 資料庫優化：
   - 合理設計文檔結構
   - 避免過深嵌套
   - 考慮讀寫頻率平衡

## 7. 實施計劃與優先級

### 7.1 第一階段：基礎功能優化

1. 白話文解釋區域添加
2. 職位限制功能實現
3. 任務解鎖條件顯示優化
4. 資料庫結構擴展

### 7.2 第二階段：團體合作機制

1. 團體投票系統實現
2. 團體任務進度顯示
3. 團隊貢獻度計算
4. 預設任務組合庫

### 7.3 第三階段：績效評分系統

1. 綜合分數計算引擎
2. 各方面評價收集機制
3. 績效儀表板實現
4. 職位基準分設定

### 7.4 第四階段：視覺獎勵系統

1. 年終獎金池實現
2. 獎金機率輪盤功能
3. 獎勵動畫效果
4. 整體UI優化

## 8. 測試與驗證計劃

1. 單元測試設計：
   - 條件計算邏輯測試
   - 白話文生成測試
   - 績效計算引擎測試

2. 整合測試：
   - 資料流程測試
   - 界面交互測試
   - 權限控制測試

3. 用戶驗收測試：
   - 管理員操作測試
   - 員工使用測試
   - 邊界條件測試

## 9. 風險評估與緩解措施

1. 數據一致性風險：
   - 使用事務確保關鍵操作的原子性
   - 實現數據校驗機制
   - 定期審計數據完整性

2. 用戶接受度風險：
   - 提供詳細文檔與教學
   - 分階段發布功能
   - 收集用戶反饋調整

3. 性能風險：
   - 監控系統性能指標
   - 針對大數據量進行壓力測試
   - 設計降級方案 